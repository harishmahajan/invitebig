<div id='newResourceLocked' class='alert alert-danger' style='display:none'>This resource is booked, some fields cannot be changed</div>
<div id='newResourceError' class='alert alert-danger' style='display:none'></div>
<div id='newResourceBreadcrumbs' style='display:none;margin-bottom:20px;font-size:12px'></div>
<div class='clearfix'></div>
<div id='formAddNewResource' class='form-horizontal' action='#'>
	<input type='hidden' id='newResourceID' value=''>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Resource Name</label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceName' placeholder='Name of the resource' />
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Resource Type</label>
		<div class='col-md-9'>
			<select id='newResourceType'>
			</select>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Description</label>
		<div class='col-md-9'>
			<textarea class='form-control' style='width:100%;height:200px' id='newResourceDescription' placeholder='Describe this resource for people that are interested in booking it'></textarea>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Pictures <small><em>(Limit 8)</em></small></label>
		<div class='col-md-9'>
			<form name='fileupload' method='POST' enctype='multipart/form-data' action='#' class='col-md-12'>
				<div id='newResourcePictures' class='row pictures' style='margin-bottom:20px' data-limit='8'></div>
				<div class='row fileupload-buttonbar'>
					<div class='col-md-11'>
						<span class='btn btn-primary fileinput-button'>
							<i class='glyphicon glyphicon-plus glyphicon-white'></i>
							<span>Add files...</span>
							<input type='file' name='files[]' multiple>
						</span>
					</div>
				</div>
				<table role='presentation' class='table table-striped' style='width:100%'><tbody class='files' data-toggle='modal-gallery' data-target='#modal-gallery'></tbody></table>
			</form>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Maximum Occupancy</label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceCapacity'>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Seating Capacity</label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceSeats' value='0'>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Lead Time <small><em>(minutes)</em></small></label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceLeadTime'>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Setup &amp; Cleanup Cost</label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceCleanupCost' value='0'>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Deposit Policy</label>
		<div class='col-md-9'>
			<select id='selectDepositList'></select>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Refund Policy</label>
		<div class='col-md-9'>
			<select id='selectRefundList'></select>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Addons Available</label>
		<div class='col-md-9'>
			<select id='selAddonsAvailable' multiple></select>
		</div>
	</div>
	<div class="form-group" id="authorize-div">
		<label class="col-md-3 control-label">Sync Calendars</label>
		<div class="col-md-9" style='padding-top:7px'>
			<img src="/assets/content/googlecal.png" width="100px" hieght="30px" id="authorize-button" onclick="handleAuthClick(event)" style="cursor:pointer">
		</div>
	</div>

	<div class='form-group'>
		<label class='col-md-3 control-label'>Auto-approve Bookings</label>
		<div class='col-md-9' style='padding-top:7px'>
			<input type='checkbox' id='newResourceAutoApprove'>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>21+ Only</label>
		<div class='col-md-9' style='padding-top:7px'>
			<input type='checkbox' id='newResourceOver21'>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Included with space</label>
		<div class='col-md-9' style='padding-top:7px'>
			<input type='checkbox' id='newResourceLinked' checked='true'>
		</div>
	</div>
	<div class='form-group'>
		<label class='col-md-3 control-label'>Billing Method</label>
		<div class='col-md-9' style='padding-top:7px'>
			<input type='radio' name='billingMethod' id='billingHourly' checked='true'> Hourly Rates
			<input type='radio' name='billingMethod' id='billingTimeslot' style='margin-left:30px'> Flat Rates
		</div>
	</div>
	<div class='form-group' id='fgHourlyRate'>
		<label class='col-md-3 control-label'>Default Hourly Rate</label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceRate'>
		</div>
	</div>
	<div class='form-group' id='fgMinDuration'>
		<label class='col-md-3 control-label'>Min Duration <small><em>(minutes)</em></small></label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceMinDuration' value='0'>
		</div>
	</div>
	<div class='form-group' id='fgIncrement'>
		<label class='col-md-3 control-label'>Increment <small><em>(minutes)</em></small></label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceIncrement' value='15'>
		</div>
	</div>
	<div class='form-group' id='fgCleanup'>
		<label class='col-md-3 control-label'>Cleanup Time <small><em>(minutes)</em></small></label>
		<div class='col-md-9'>
			<input type='text' class='form-control' id='newResourceCleanupTime' value='0'>
		</div>
	</div>
	<div class='form-group' id='fgHours'>
		<label class='col-md-3 control-label'>Hours of Operation</label>
		<div class='col-md-9'>
			<table class='timeslot-widget dtable'>
				<thead><tr><th>Days of the week</th><th>Start Time</th><th>End Time</th><th></th></tr></thead>
				<tbody></tbody>
				<tfoot><tr><td colspan=10><button class='btn btn-xs btn-primary tsAdd'>Add New Timeslot</button><button class='btn btn-xs btn-default ts24x7'>Add 24x7 Timeslot</button></td></tr></tfoot>
			</table>
		</div>
	</div>
	<div class='form-group' id='fgSpecialRates'>
		<label class='col-md-3 control-label'>Special Rates</label>
		<div class='col-md-9'>
			<table class='timeslot-widget timeslot-widget-rate dtable'>
				<thead><tr><th>Days of the week</th><th>Start Time</th><th>End Time</th><th>Hourly Rate</th><th></th></tr></thead>
				<tbody></tbody>
				<tfoot><tr><td colspan=10><button class='btn btn-xs btn-primary tsAdd'>Add New Timeslot</button><button class='btn btn-xs btn-default ts24x7'>Add 24x7 Timeslot</button></td></tr></tfoot>
			</table>
		</div>
	</div>
	<div class='form-group' id='fgTimeslots' style='display:none'>
		<label class='col-md-3 control-label'>Timeslots</label>
		<div class='col-md-9'>
			<table class='timeslot-widget timeslot-widget-rate timeslot-widget-combinable dtable'>
				<thead><tr><th>Days of the week</th><th>Start Time</th><th>End Time</th><th>Cost</th><th></th><th></th></tr></thead>
				<tbody></tbody>
				<tfoot><tr><td colspan=10><button class='btn btn-xs btn-primary tsAdd'>Add New Timeslot</button><button class='btn btn-xs btn-default ts24x7'>Add 24x7 Timeslot</button></td></tr></tfoot>
			</table>
		</div>
	</div>

 <script type="text/javascript">
      // Your Client ID can be retrieved from your project in the Google
      // Developer Console, https://console.developers.google.com
      //alert(localStorage.getItem('venueid'));
      //alert(localStorage.getItem("activeProfile"));
      var CLIENT_ID = '41840486781-6fit272os86kor3s4d2iebail0hmk1fj.apps.googleusercontent.com';

      var SCOPES = ["https://www.googleapis.com/auth/calendar"];

      /**
       * Check if current user has authorized this application.
       */
      function checkAuth() {
      	
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          }, handleAuthResult);
      }
      // Cid= 41840486781-6fit272os86kor3s4d2iebail0hmk1fj.apps.googleusercontent.com
      // secret= 0M3Wfu8TbofdsNJ-oCosaaie

      /**
       * Handle response from authorization server.
       *
       * @param {Object} authResult Authorization result.
       */
      function handleAuthResult(authResult) {
        var authorizeDiv = document.getElementById('authorize-div');
        if (authResult && !authResult.error) {
          // Hide auth UI, then load client library.
          authorizeDiv.style.display = 'none';
          loadCalendarApi();
        } else {
          // Show auth UI, allowing the user to initiate authorization by
          // clicking authorize button.
          authorizeDiv.style.display = 'inline';
        }
      }

      /**
       * Initiate auth flow in response to user clicking authorize button.
       *
       * @param {Event} event Button click event.
       */
      function handleAuthClick(event) {
        gapi.auth.authorize(
          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
          handleAuthResult);
        return false;
      }

      /**
       * Load Google Calendar client library. List upcoming events
       * once client library is loaded.
       */
      function loadCalendarApi() {
        gapi.client.load('calendar', 'v3', listUpcomingEvents);
      }

      /**
       * Print the summary and start datetime/date of the next ten events in
       * the authorized user's calendar. If no events are found an
       * appropriate message is printed.
       */
      function listUpcomingEvents() {
        var request = gapi.client.calendar.events.list({
          'calendarId': 'primary',
          'timeMin': (new Date()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        });

        request.execute(function(resp) {
          var events = resp.items;
          //alert("harish");
          var todaysdate=Date();
          todaysdate=convertToTimestamp(todaysdate);
          todaysdate = todaysdate.toString().substring(0, 10);
          if (events.length > 0) {
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              var when = event.start.dateTime;
              var end = event.end.dateTime;
              
              if (!when) {
                when = event.start.date;
                end = event.end.date;
                
              }
              var startD = convertToTimestamp(when);
              startD = startD.toString().substring(0, 10); 
              var endD = convertToTimestamp(end);
              endD = endD.toString().substring(0, 10)
              var calupdatedate = convertToTimestamp(event.updated);
              calupdatedate = calupdatedate.toString().substring(0,10);
             
              //alert(startD);
              var eventname = event.summary;
              var calid = event.id;
              //console.log(calid);
			        var description = event.description;
			        var contact_email = event.organizer.email;
			        var rsid = localStorage.getItem("sync_resouceid");
              var venueid = localStorage.getItem("activeProfile");

              var caldata={'eventname':eventname,'st':startD,'endt':endD,'todaysdate':todaysdate,'description':description,'contact_email':contact_email,'calupdatedate':calupdatedate,'calid':calid,'resourceid':rsid,'venueid':venueid};

              var postdata = {'todaysdate':todaysdate};

         

              //alert(startD.toString().substring(0, 10));
              //str.substring(1, 4); 
              //syncToDatabase(caldata);
              //syncToGoogleCalendar(postdata);
              // alert(localStorage.getItem("sync_resouceid"));
              //alert(eventname+"Start:- "+when+" End:-"+end);
              //alert(contact_name);
              //alert(caldata);
              // $.get("php/googlesynctodb.php", function(data, status){
              // 	alert("Data: " + data + "\nStatus: " + status);
              // });
              
          }
            var postdata = {'todaysdate':todaysdate};
            syncToGoogleCalendar(postdata);
        
      } else {
      	//appendPre('No upcoming events found.');
      }
                   
  	});
 	}
 	function syncToDatabase(caldata)
 	{
 		//console.log(caldata);
 		$.ajax({
              	url: "php/googlesynctodb.php", 
              	type: 'POST',
              	data: caldata,
              	success: function(result)
              	{
              		console.log(result);
                 //  var todaysdate=Date();
                 //  todaysdate=convertToTimestamp(todaysdate);
                 //  todaysdate = todaysdate.toString().substring(0, 10);
              	  // var postdata = {'todaysdate':todaysdate};
                 //  syncToGoogleCalendar(postdata);
              	},
              	error:function(er){
              		alert(er);
              	}

              });
 	}
 	function syncToGoogleCalendar(postdata)
 	{
 		//alert("Call");
 		$.ajax({
 			url:"php/googlesync.php",
 			type:'POST',
 			data:postdata,
 			success:function(result)
 			{
 				result=JSON.parse(result);
 				alert("Call123");
 				console.log(result);
 				for (var i = 0; i < result.length; i++) {
 					// console.log(result[i].eventname);
 					// console.log(result[i].bookingid);
 					// console.log(result[i].start);
 					// console.log(result[i].stop);
 					// console.log(result[i].cal_updatedate);
 					// console.log(result[i].cal_id);
 					//console.log(result[i].timezone);
 					//console.log(result[i].address);
 					//console.log(result[i].description);
 					var ev = result[i].eventname;
 					var st = result[i].start+'000';
 					var en = result[i].stop+'000';
 					var tz = result[i].timezone;
 					var eventdescrption= result[i].description;
          var email = result[i].contact_email;
          var address= result[i].address;
 					var stdt = moment.tz(parseInt(st), tz).format();
 					var endt = moment.tz(parseInt(en), tz).format();
 					//createevent(ev,stdt,endt,tz,eventdescrption,address,email);
 				}
 			}
 		});
 	}

       
 	function convertToTimestamp(d)
 	{
      	var d = new Date(d);
              var month = d.getMonth();
              month = month + 1;
              var fullDate =  d.getDate()+"-"+month+"-"+d.getFullYear()+" "+d.getHours()+":"+d.getMinutes();
              //alert(fullDate);
              var dateString = fullDate,
			    dateTimeParts = dateString.split(' '),
			    timeParts = dateTimeParts[1].split(':'),
			    dateParts = dateTimeParts[0].split('-'),
			    date;

			    date = new Date(dateParts[2], parseInt(dateParts[1], 10) - 1, dateParts[0], timeParts[0], timeParts[1]);
			    //console.log(date.getTime()); 
			    return date.getTime();
      }
      /**
       * Append a pre element to the body containing the given message
       * as its text node.
       *
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(message) {
      	// alert('appendPre');
       //  var pre = document.getElementById('output');
       //  var textContent = document.createTextNode(message + '\n');
       //  pre.appendChild(textContent);
      }

      function createevent(e,st,en,tz,desc,address,email)
      {
        //alert("create");
          var event = {
            'summary': e,
            'location': address,
            'description': desc,
            'start': {
              'dateTime': st,
              'timeZone': tz
            },
            'end': {
              'dateTime': en,
              'timeZone': tz
            },
            'recurrence': [
              'RRULE:FREQ=DAILY;COUNT=2'
            ],
            'attendees': [
              {'email': email}
            ],
            'reminders': {
              'useDefault': false,
              'overrides': [
                {'method': 'email', 'minutes': 24 * 60},
                {'method': 'popup', 'minutes': 10}
              ]
            }
          };

          var request = gapi.client.calendar.events.insert({
            'calendarId': 'primary',
            'resource': event
          });

          request.execute(function(event) {
          	alert('Event Created....!!!');
            //appendPre('Event created: ' + event.htmlLink);
          });
        }

    </script>
    <script src="https://apis.google.com/js/client.js">
    </script>
<script>
	$("input[name='billingMethod']").on('change',function()
	{
		if ($("#billingHourly").prop("checked"))
		{
			$("#fgHourlyRate").show();
			$("#fgMinDuration").show();
			$("#fgIncrement").show();
			$("#fgCleanup").show();
			$("#fgHours").show();
			$("#fgSpecialRates").show();
			$("#fgTimeslots").hide();
		}
		else
		{
			$("#fgHourlyRate").hide();
			$("#fgMinDuration").hide();
			$("#fgIncrement").hide();
			$("#fgCleanup").hide();
			$("#fgHours").hide();
			$("#fgSpecialRates").hide();
			$("#fgTimeslots").show();
		}
	});	
	
	$("table.timeslot-widget").each(function(){$(this).tsWidget();});
	
</script>
